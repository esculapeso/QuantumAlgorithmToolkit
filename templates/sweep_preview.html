{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Header -->
        <div class="col-12 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <h3>
                    Parameter Sweep Preview: {{ sweep.session_id }}
                    <span class="badge bg-primary">{{ sweep.circuit_type }}</span>
                </h3>
                <div>
                    <a href="{{ url_for('sweep_grid', sweep_session=sweep.session_id) }}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-grid-3x3-gap"></i> Grid View
                    </a>
                    <a href="{{ url_for('parameter_sweep') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-left"></i> Back to Parameter Sweep
                    </a>
                </div>
            </div>
            <div class="text-muted small">
                Created: {{ sweep.created_at.strftime('%Y-%m-%d %H:%M') }} | 
                Simulations: {{ sweep.completed_simulations }}/{{ sweep.total_simulations }}
                {% if sweep.param1 or sweep.param2 %}
                <div class="mt-1">
                    Parameters: 
                    {% if sweep.param1 %}
                    <span class="badge bg-secondary">{{ sweep.param1 }}</span>
                    {% endif %}
                    {% if sweep.param2 %}
                    <span class="badge bg-secondary">{{ sweep.param2 }}</span>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Frequency Spectra -->
    <div class="row">
        {% for sim in simulations %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">{{ sim.result_name.split('_')[-1] }}</h6>
                        <a href="{{ url_for('view_result', result_name=sim.result_name) }}" class="btn btn-sm btn-outline-primary">
                            View Details
                        </a>
                    </div>
                </div>
                <a href="#" class="spectrum-lightbox" data-spectrum-url="{{ url_for('get_figure', result_name=sim.result_name, figure_name='fft_analysis.png') }}">
                    <img src="{{ url_for('get_figure', result_name=sim.result_name, figure_name='fft_analysis.png') }}" 
                         class="card-img-top" 
                         alt="Frequency Spectrum"
                         style="height: 200px; object-fit: contain;">
                </a>
                <div class="card-body">
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <div>
                                <span class="text-muted">Qubits:</span> {{ sim.qubits }}
                            </div>
                            <div>
                                <span class="text-muted">Drive Param:</span> {{ sim.drive_param }}
                            </div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <div>
                                <span class="text-muted">Time Points:</span> {{ sim.time_points }}
                            </div>
                            <div>
                                <span class="text-muted">Drive Freq:</span> {{ "%.4f"|format(sim.drive_frequency) if sim.drive_frequency else "N/A" }}
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            {% if sim.time_crystal_detected %}
                            <span class="badge bg-success">Time Crystal</span>
                            {% endif %}
                            {% if sim.incommensurate_count > 0 %}
                            <span class="badge bg-info">{{ sim.incommensurate_count }} Incommensurate</span>
                            {% endif %}
                        </div>
                        <small class="text-muted">{{ sim.created_at.strftime('%H:%M:%S') }}</small>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Lightbox Modal -->
<div class="modal fade" id="spectrumModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Frequency Spectrum</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img src="" id="modalSpectrumImage" class="img-fluid" alt="Frequency Spectrum">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set up lightbox functionality for spectrum images
        const spectrumLinks = document.querySelectorAll('.spectrum-lightbox');
        const modal = new bootstrap.Modal(document.getElementById('spectrumModal'));
        const modalImage = document.getElementById('modalSpectrumImage');
        
        spectrumLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const spectrumUrl = this.getAttribute('data-spectrum-url');
                modalImage.src = spectrumUrl;
                modal.show();
            });
        });
    });
</script>
{% endblock %}